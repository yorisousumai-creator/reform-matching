<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¡ˆä»¶ç®¡ç† - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: sans-serif;
      background-color: #f5f5f5;
    }
    .header {
      background-color: #4caf50;
      color: #fff;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .header h1 {
      font-size: 24px;
    }
    .container {
      max-width: 1400px;
      margin: 20px auto;
      padding: 0 20px;
    }
    .top-bar {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    .filters {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .filters label {
      font-weight: bold;
      font-size: 14px;
    }
    .filters select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      transition: all 0.2s;
    }
    .btn-primary {
      background-color: #4caf50;
      color: #fff;
    }
    .btn-primary:hover {
      background-color: #43a047;
    }
    .btn-secondary {
      background-color: #2196f3;
      color: #fff;
      font-size: 12px;
      padding: 6px 12px;
    }
    .btn-secondary:hover {
      background-color: #1976d2;
    }
    .btn-danger {
      background-color: #f44336;
      color: #fff;
      font-size: 12px;
      padding: 6px 12px;
    }
    .btn-danger:hover {
      background-color: #d32f2f;
    }
    .cases-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 20px;
    }
    .case-card {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-left: 5px solid #9e9e9e;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .case-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ã®è‰²åˆ†ã‘ */
    .case-card.status-new {
      border-left-color: #2196f3; /* é’ - æ–°è¦ */
    }
    .case-card.status-checking {
      border-left-color: #ff9800; /* ã‚ªãƒ¬ãƒ³ã‚¸ - ç¢ºèªä¸­ */
    }
    .case-card.status-estimating {
      border-left-color: #9c27b0; /* ç´« - è¦‹ç©ä½œæˆä¸­ */
    }
    .case-card.status-proposed {
      border-left-color: #00bcd4; /* ã‚·ã‚¢ãƒ³ - ææ¡ˆæ¸ˆ */
    }
    .case-card.status-ordered {
      border-left-color: #4caf50; /* ç·‘ - å—æ³¨ */
    }
    .case-card.status-construction {
      border-left-color: #ffc107; /* é»„è‰² - æ–½å·¥ä¸­ */
    }
    .case-card.status-done {
      border-left-color: #607d8b; /* ã‚°ãƒ¬ãƒ¼ - å®Œäº† */
    }
    .case-card.status-failed {
      border-left-color: #f44336; /* èµ¤ - ä¸æˆç«‹ */
    }
    .case-card.priority-high {
      box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);
    }
    .case-card.priority-urgent {
      box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
    }
    .case-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .case-id {
      font-size: 11px;
      color: #999;
      margin-bottom: 5px;
    }
    .case-customer {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }
    .case-priority {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: bold;
      margin-left: 8px;
    }
    .priority-normal {
      background-color: #e0e0e0;
      color: #666;
    }
    .priority-high {
      background-color: #ffe0b2;
      color: #e65100;
    }
    .priority-urgent {
      background-color: #ffcdd2;
      color: #c62828;
    }
    .case-info {
      font-size: 14px;
      color: #666;
      line-height: 1.8;
      margin-bottom: 10px;
    }
    .case-info strong {
      color: #333;
    }
    .case-details-wrapper {
      margin: 10px 0;
    }
    .case-details {
      background-color: #f9f9f9;
      padding: 12px;
      border-radius: 4px;
      font-size: 13px;
      color: #555;
      line-height: 1.6;
      white-space: pre-wrap; /* æ”¹è¡Œã‚’ä¿æŒ */
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .case-details.expanded {
      max-height: 500px;
      overflow-y: auto;
    }
    .case-details-toggle {
      background: none;
      border: none;
      color: #2196f3;
      cursor: pointer;
      font-size: 13px;
      padding: 5px 0;
      text-decoration: underline;
      font-weight: bold;
    }
    .case-details-toggle:hover {
      color: #1976d2;
    }
    .case-notes {
      background-color: #fff3e0;
      padding: 12px;
      border-radius: 4px;
      margin: 10px 0;
      font-size: 13px;
      border-left: 3px solid #ff9800;
      white-space: pre-wrap; /* æ”¹è¡Œã‚’ä¿æŒ */
    }
    .case-memo {
      background-color: #e8f5e9;
      padding: 12px;
      border-radius: 4px;
      margin: 10px 0;
      font-size: 13px;
      border-left: 3px solid #4caf50;
    }
    .case-memo textarea {
      width: 100%;
      min-height: 60px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
      resize: vertical;
      margin-top: 5px;
    }
    .case-memo-content {
      white-space: pre-wrap;
      line-height: 1.6;
    }
    .case-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
      align-items: center;
      flex-wrap: wrap;
    }
    .status-select {
      flex: 1;
      min-width: 120px;
      padding: 8px;
      border: 2px solid #4caf50;
      border-radius: 4px;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      background-color: #fff;
    }
    .status-select:focus {
      outline: none;
      border-color: #43a047;
    }
    .case-date {
      font-size: 12px;
      color: #999;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }
    .loading {
      text-align: center;
      padding: 50px;
      color: #999;
    }
    .empty {
      text-align: center;
      padding: 50px;
      color: #999;
      background: #fff;
      border-radius: 8px;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stat-number {
      font-size: 32px;
      font-weight: bold;
      color: #4caf50;
    }
    .stat-label {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      overflow-y: auto;
    }
    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-content {
      background: #fff;
      border-radius: 8px;
      padding: 30px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #eee;
    }
    .modal-header h2 {
      font-size: 20px;
      color: #333;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #999;
      line-height: 1;
      padding: 0;
    }
    .modal-close:hover {
      color: #333;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 8px;
      color: #555;
      font-size: 14px;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    @media (max-width: 768px) {
      .cases-grid {
        grid-template-columns: 1fr;
      }
      .top-bar {
        flex-direction: column;
        align-items: stretch;
      }
      .filters {
        flex-direction: column;
      }
      .filters select {
        width: 100%;
      }
      .case-actions {
        flex-direction: column;
      }
      .status-select {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ“‹ æ¡ˆä»¶ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
  </div>

  <div class="container">
    <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
    <div class="stats">
      <div class="stat-card">
        <div class="stat-number" id="statTotal">0</div>
        <div class="stat-label">ç·æ¡ˆä»¶æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="statNew">0</div>
        <div class="stat-label">æ–°è¦</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="statProgress">0</div>
        <div class="stat-label">å¯¾å¿œä¸­</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="statDone">0</div>
        <div class="stat-label">å®Œäº†</div>
      </div>
    </div>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <div class="top-bar">
      <div class="filters">
        <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼š</label>
        <select id="statusFilter">
          <option value="all">ã™ã¹ã¦</option>
          <option value="æ–°è¦">æ–°è¦</option>
          <option value="ç¢ºèªä¸­">ç¢ºèªä¸­</option>
          <option value="è¦‹ç©ä½œæˆä¸­">è¦‹ç©ä½œæˆä¸­</option>
          <option value="ææ¡ˆæ¸ˆ">ææ¡ˆæ¸ˆ</option>
          <option value="å—æ³¨">å—æ³¨</option>
          <option value="æ–½å·¥ä¸­">æ–½å·¥ä¸­</option>
          <option value="å®Œäº†">å®Œäº†</option>
          <option value="ä¸æˆç«‹">ä¸æˆç«‹</option>
        </select>
        
        <label>å„ªå…ˆåº¦ï¼š</label>
        <select id="priorityFilter">
          <option value="all">ã™ã¹ã¦</option>
          <option value="è‡³æ€¥">è‡³æ€¥</option>
          <option value="é«˜">é«˜</option>
          <option value="é€šå¸¸">é€šå¸¸</option>
        </select>
      </div>
      
      <button onclick="loadCases()" class="btn btn-primary">
        ğŸ”„ æ›´æ–°
      </button>
    </div>

    <div id="loading" class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
    <div id="cases" class="cases-grid"></div>
    <div id="empty" class="empty" style="display: none;">
      æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“
    </div>
  </div>

  <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>æ¡ˆä»¶ã‚’ç·¨é›†</h2>
        <button class="modal-close" onclick="closeEditModal()">&times;</button>
      </div>
      <form id="editForm">
        <input type="hidden" id="editId">
        
        <div class="form-group">
          <label>é¡§å®¢å</label>
          <input type="text" id="editCustomerName" required>
        </div>
        
        <div class="form-group">
          <label>é›»è©±ç•ªå·</label>
          <input type="tel" id="editCustomerPhone" required>
        </div>
        
        <div class="form-group">
          <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
          <input type="email" id="editCustomerEmail">
        </div>
        
        <div class="form-group">
          <label>éƒµä¾¿ç•ªå·</label>
          <input type="text" id="editPostalCode" required>
        </div>
        
        <div class="form-group">
          <label>éƒ½é“åºœçœŒ</label>
          <input type="text" id="editPrefecture" required>
        </div>
        
        <div class="form-group">
          <label>å¸‚åŒºç”ºæ‘</label>
          <input type="text" id="editCity" required>
        </div>
        
        <div class="form-group">
          <label>ä½æ‰€ï¼ˆç•ªåœ°ä»¥é™ï¼‰</label>
          <input type="text" id="editAddress">
        </div>
        
        <div class="form-group">
          <label>ãƒªãƒ•ã‚©ãƒ¼ãƒ ç®‡æ‰€</label>
          <select id="editReformType" required>
            <option value="ã‚­ãƒƒãƒãƒ³">ã‚­ãƒƒãƒãƒ³</option>
            <option value="é¢¨å‘‚ãƒ»æµ´å®¤">é¢¨å‘‚ãƒ»æµ´å®¤</option>
            <option value="ãƒˆã‚¤ãƒ¬">ãƒˆã‚¤ãƒ¬</option>
            <option value="æ´—é¢æ‰€">æ´—é¢æ‰€</option>
            <option value="å¤–å£">å¤–å£</option>
            <option value="å±‹æ ¹">å±‹æ ¹</option>
            <option value="å†…è£…">å†…è£…</option>
            <option value="å…¨é¢ãƒªãƒ•ã‚©ãƒ¼ãƒ ">å…¨é¢ãƒªãƒ•ã‚©ãƒ¼ãƒ </option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>äºˆç®—</label>
          <select id="editBudgetRange">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="50ä¸‡å††æœªæº€">50ä¸‡å††æœªæº€</option>
            <option value="50-100ä¸‡å††">50ã€œ100ä¸‡å††</option>
            <option value="100-200ä¸‡å††">100ã€œ200ä¸‡å††</option>
            <option value="200-300ä¸‡å††">200ã€œ300ä¸‡å††</option>
            <option value="300-500ä¸‡å††">300ã€œ500ä¸‡å††</option>
            <option value="500ä¸‡å††ä»¥ä¸Š">500ä¸‡å††ä»¥ä¸Š</option>
            <option value="æœªå®š">æœªå®š</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>ç€å·¥å¸Œæœ›æ™‚æœŸ</label>
          <select id="editDesiredStartDate">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="ã™ãã«ã§ã‚‚">ã™ãã«ã§ã‚‚</option>
            <option value="1ãƒ¶æœˆä»¥å†…">1ãƒ¶æœˆä»¥å†…</option>
            <option value="2-3ãƒ¶æœˆä»¥å†…">2ã€œ3ãƒ¶æœˆä»¥å†…</option>
            <option value="åŠå¹´ä»¥å†…">åŠå¹´ä»¥å†…</option>
            <option value="æœªå®š">æœªå®š</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>å„ªå…ˆåº¦</label>
          <select id="editPriority">
            <option value="é€šå¸¸">é€šå¸¸</option>
            <option value="é«˜">é«˜</option>
            <option value="è‡³æ€¥">è‡³æ€¥</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>è©³ç´°ãƒ»è¦æœ›</label>
          <textarea id="editDetails" rows="5"></textarea>
        </div>
        
        <div class="form-group">
          <label>Aç¤¾ã‹ã‚‰ã®ç‰¹è¨˜äº‹é …</label>
          <textarea id="editContractorNotes" rows="3"></textarea>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 30px;">
          <button type="submit" class="btn btn-primary" style="flex: 1;">
            ä¿å­˜
          </button>
          <button type="button" class="btn" style="flex: 1; background-color: #757575; color: #fff;" onclick="closeEditModal()">
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    
    const SUPABASE_URL = 'https://phkfsozxquabtzajmqwh.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_238uos3NzkiGfsEliDrjdw_-qorclBl';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    const loading = document.getElementById('loading');
    const casesContainer = document.getElementById('cases');
    const empty = document.getElementById('empty');
    const statusFilter = document.getElementById('statusFilter');
    const priorityFilter = document.getElementById('priorityFilter');
    const editModal = document.getElementById('editModal');
    const editForm = document.getElementById('editForm');
    
    // çµ±è¨ˆã‚’æ›´æ–°
    function updateStats(data) {
      document.getElementById('statTotal').textContent = data.length;
      document.getElementById('statNew').textContent = data.filter(c => c.status === 'æ–°è¦').length;
      document.getElementById('statProgress').textContent = data.filter(c => 
        ['ç¢ºèªä¸­', 'è¦‹ç©ä½œæˆä¸­', 'ææ¡ˆæ¸ˆ', 'å—æ³¨', 'æ–½å·¥ä¸­'].includes(c.status)
      ).length;
      document.getElementById('statDone').textContent = data.filter(c => c.status === 'å®Œäº†').length;
    }
    
    // æ¡ˆä»¶ã‚’èª­ã¿è¾¼ã¿
    window.loadCases = async function() {
      loading.style.display = 'block';
      casesContainer.style.display = 'none';
      empty.style.display = 'none';
      
      let query = supabase
        .from('inquiries')
        .select('*')
        .order('created_at', { ascending: false });
      
      const status = statusFilter.value;
      const priority = priorityFilter.value;
      
      if (status !== 'all') {
        query = query.eq('status', status);
      }
      
      if (priority !== 'all') {
        query = query.eq('priority', priority);
      }
      
      const { data, error } = await query;
      
      loading.style.display = 'none';
      
      if (error) {
        console.error('ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        return;
      }
      
      // çµ±è¨ˆã‚’æ›´æ–°ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‰ã®å…¨ãƒ‡ãƒ¼ã‚¿ã§ï¼‰
      const { data: allData } = await supabase.from('inquiries').select('*');
      if (allData) updateStats(allData);
      
      if (data.length === 0) {
        empty.style.display = 'block';
        return;
      }
      
      casesContainer.style.display = 'grid';
      casesContainer.innerHTML = data.map(c => createCaseCard(c)).join('');
    };
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸã‚¯ãƒ©ã‚¹åã‚’å–å¾—
    function getStatusClass(status) {
      const statusMap = {
        'æ–°è¦': 'status-new',
        'ç¢ºèªä¸­': 'status-checking',
        'è¦‹ç©ä½œæˆä¸­': 'status-estimating',
        'ææ¡ˆæ¸ˆ': 'status-proposed',
        'å—æ³¨': 'status-ordered',
        'æ–½å·¥ä¸­': 'status-construction',
        'å®Œäº†': 'status-done',
        'ä¸æˆç«‹': 'status-failed'
      };
      return statusMap[status] || '';
    }
    
    // æ¡ˆä»¶ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
    function createCaseCard(c) {
      const hasDetails = c.details && c.details.trim();
      const hasContractorNotes = c.contractor_notes && c.contractor_notes.trim();
      const hasMemo = c.notes && c.notes.trim();
      
      return `
        <div class="case-card ${getStatusClass(c.status)} ${getPriorityClass(c.priority)}" data-id="${c.id}">
          <div class="case-header">
            <div>
              <div class="case-id">ID: ${c.id.slice(0, 8)}</div>
              <div class="case-customer">
                ${c.customer_name}
                <span class="case-priority ${getPriorityBadgeClass(c.priority)}">
                  ${c.priority || 'é€šå¸¸'}
                </span>
              </div>
            </div>
          </div>
          
          <div class="case-info">
            <strong>ğŸ“</strong> ${c.customer_phone}<br>
            ${c.customer_email ? `<strong>ğŸ“§</strong> ${c.customer_email}<br>` : ''}
            <strong>ğŸ“</strong> ${c.prefecture}${c.city}${c.address ? ' ' + c.address : ''}<br>
            <strong>ğŸ”§</strong> ${c.reform_type}<br>
            ${c.budget_range ? `<strong>ğŸ’°</strong> ${c.budget_range}<br>` : ''}
            ${c.desired_start_date ? `<strong>ğŸ“…</strong> ${c.desired_start_date}<br>` : ''}
          </div>
          
          ${hasDetails ? `
            <div class="case-details-wrapper">
              <button class="case-details-toggle" onclick="toggleDetails('${c.id}')">
                ğŸ“„ è©³ç´°ã‚’è¦‹ã‚‹
              </button>
              <div class="case-details" id="details-${c.id}">
                <strong>è©³ç´°ãƒ»è¦æœ›ï¼š</strong><br>${c.details}
              </div>
            </div>
          ` : ''}
          
          ${hasContractorNotes ? `
            <div class="case-notes">
              <strong>âš ï¸ Aç¤¾ã‹ã‚‰ã®ç‰¹è¨˜äº‹é …ï¼š</strong><br>${c.contractor_notes}
            </div>
          ` : ''}
          
          <!-- è·äººãƒ¡ãƒ¢ -->
          <div class="case-memo">
            <strong>ğŸ“ ãƒ¡ãƒ¢ï¼š</strong>
            ${hasMemo ? `
              <div class="case-memo-content" id="memo-display-${c.id}">${c.notes}</div>
              <button class="case-details-toggle" onclick="editMemo('${c.id}', ${JSON.stringify(c.notes || '').replace(/"/g, '&quot;')})">
                ç·¨é›†
              </button>
            ` : `
              <button class="case-details-toggle" onclick="editMemo('${c.id}', '')">
                ãƒ¡ãƒ¢ã‚’è¿½åŠ 
              </button>
            `}
            <div id="memo-edit-${c.id}" style="display: none;">
              <textarea id="memo-input-${c.id}" rows="3">${c.notes || ''}</textarea>
              <div style="display: flex; gap: 5px; margin-top: 5px;">
                <button class="btn btn-secondary" onclick="saveMemo('${c.id}')">ä¿å­˜</button>
                <button class="btn" style="background-color: #757575; color: #fff; font-size: 12px; padding: 6px 12px;" onclick="cancelMemo('${c.id}')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              </div>
            </div>
          </div>
          
          <div class="case-actions">
            <select class="status-select" onchange="updateStatus('${c.id}', this.value)">
              <option value="æ–°è¦" ${c.status === 'æ–°è¦' ? 'selected' : ''}>æ–°è¦</option>
              <option value="ç¢ºèªä¸­" ${c.status === 'ç¢ºèªä¸­' ? 'selected' : ''}>ç¢ºèªä¸­</option>
              <option value="è¦‹ç©ä½œæˆä¸­" ${c.status === 'è¦‹ç©ä½œæˆä¸­' ? 'selected' : ''}>è¦‹ç©ä½œæˆä¸­</option>
              <option value="ææ¡ˆæ¸ˆ" ${c.status === 'ææ¡ˆæ¸ˆ' ? 'selected' : ''}>ææ¡ˆæ¸ˆ</option>
              <option value="å—æ³¨" ${c.status === 'å—æ³¨' ? 'selected' : ''}>å—æ³¨</option>
              <option value="æ–½å·¥ä¸­" ${c.status === 'æ–½å·¥ä¸­' ? 'selected' : ''}>æ–½å·¥ä¸­</option>
              <option value="å®Œäº†" ${c.status === 'å®Œäº†' ? 'selected' : ''}>å®Œäº†</option>
              <option value="ä¸æˆç«‹" ${c.status === 'ä¸æˆç«‹' ? 'selected' : ''}>ä¸æˆç«‹</option>
            </select>
            <button class="btn btn-secondary" onclick="openEditModal('${c.id}')">
              âœï¸ ç·¨é›†
            </button>
            <button class="btn btn-danger" onclick="deleteCase('${c.id}', '${c.customer_name}')">
              ğŸ—‘ï¸ å‰Šé™¤
            </button>
          </div>
          
          <div class="case-date">
            ç™»éŒ²: ${new Date(c.created_at).toLocaleString('ja-JP')}<br>
            æ›´æ–°: ${new Date(c.updated_at).toLocaleString('ja-JP')}
          </div>
        </div>
      `;
    }
    
    // è©³ç´°ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    window.toggleDetails = function(id) {
      const detailsDiv = document.getElementById(`details-${id}`);
      const button = detailsDiv.previousElementSibling;
      
      if (detailsDiv.classList.contains('expanded')) {
        detailsDiv.classList.remove('expanded');
        button.textContent = 'ğŸ“„ è©³ç´°ã‚’è¦‹ã‚‹';
      } else {
        detailsDiv.classList.add('expanded');
        button.textContent = 'ğŸ“„ è©³ç´°ã‚’é–‰ã˜ã‚‹';
      }
    };
    
    // ãƒ¡ãƒ¢ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
    window.editMemo = function(id, currentMemo) {
      const displayDiv = document.getElementById(`memo-display-${id}`);
      const editDiv = document.getElementById(`memo-edit-${id}`);
      
      if (displayDiv) displayDiv.style.display = 'none';
      if (editDiv) {
        editDiv.style.display = 'block';
        const textarea = document.getElementById(`memo-input-${id}`);
        textarea.focus();
      }
    };
    
    // ãƒ¡ãƒ¢ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    window.cancelMemo = function(id) {
      const displayDiv = document.getElementById(`memo-display-${id}`);
      const editDiv = document.getElementById(`memo-edit-${id}`);
      
      if (displayDiv) displayDiv.style.display = 'block';
      editDiv.style.display = 'none';
    };
    
    // ãƒ¡ãƒ¢ã‚’ä¿å­˜
    window.saveMemo = async function(id) {
      const textarea = document.getElementById(`memo-input-${id}`);
      const memo = textarea.value;
      
      const { error } = await supabase
        .from('inquiries')
        .update({ notes: memo })
        .eq('id', id);
      
      if (error) {
        console.error('ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ¡ãƒ¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } else {
        loadCases();
      }
    };
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
    window.updateStatus = async function(id, newStatus) {
      const { error } = await supabase
        .from('inquiries')
        .update({ status: newStatus })
        .eq('id', id);
      
      if (error) {
        console.error('ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        loadCases();
      } else {
        // æˆåŠŸã—ãŸã‚‰çµ±è¨ˆã¨ã‚«ãƒ¼ãƒ‰ã®è‰²ã ã‘æ›´æ–°
        const { data: allData } = await supabase.from('inquiries').select('*');
        if (allData) updateStats(allData);
        
        // ã‚«ãƒ¼ãƒ‰ã®è‰²ã‚’æ›´æ–°
        const card = document.querySelector(`[data-id="${id}"]`);
        if (card) {
          card.className = `case-card ${getStatusClass(newStatus)}`;
        }
      }
    };
    
    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.openEditModal = async function(id) {
      const { data, error } = await supabase
        .from('inquiries')
        .select('*')
        .eq('id', id)
        .single();
      
      if (error || !data) {
        alert('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        return;
      }
      
      document.getElementById('editId').value = data.id;
      document.getElementById('editCustomerName').value = data.customer_name;
      document.getElementById('editCustomerPhone').value = data.customer_phone;
      document.getElementById('editCustomerEmail').value = data.customer_email || '';
      document.getElementById('editPostalCode').value = data.postal_code;
      document.getElementById('editPrefecture').value = data.prefecture;
      document.getElementById('editCity').value = data.city;
      document.getElementById('editAddress').value = data.address || '';
      document.getElementById('editReformType').value = data.reform_type;
      document.getElementById('editBudgetRange').value = data.budget_range || '';
      document.getElementById('editDesiredStartDate').value = data.desired_start_date || '';
      document.getElementById('editPriority').value = data.priority || 'é€šå¸¸';
      document.getElementById('editDetails').value = data.details || '';
      document.getElementById('editContractorNotes').value = data.contractor_notes || '';
      
      editModal.classList.add('show');
    };
    
    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeEditModal = function() {
      editModal.classList.remove('show');
    };
    
    // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    editForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const id = document.getElementById('editId').value;
      const updateData = {
        customer_name: document.getElementById('editCustomerName').value,
        customer_phone: document.getElementById('editCustomerPhone').value,
        customer_email: document.getElementById('editCustomerEmail').value || null,
        postal_code: document.getElementById('editPostalCode').value,
        prefecture: document.getElementById('editPrefecture').value,
        city: document.getElementById('editCity').value,
        address: document.getElementById('editAddress').value || null,
        reform_type: document.getElementById('editReformType').value,
        budget_range: document.getElementById('editBudgetRange').value || null,
        desired_start_date: document.getElementById('editDesiredStartDate').value || null,
        priority: document.getElementById('editPriority').value,
        details: document.getElementById('editDetails').value || null,
        contractor_notes: document.getElementById('editContractorNotes').value || null
      };
      
      const { error } = await supabase
        .from('inquiries')
        .update(updateData)
        .eq('id', id);
      
      if (error) {
        console.error('ã‚¨ãƒ©ãƒ¼:', error);
        alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } else {
        closeEditModal();
        loadCases();
      }
    });
    
    // æ¡ˆä»¶ã‚’å‰Šé™¤
    window.deleteCase = async function(id, customerName) {
      if (!confirm(`æœ¬å½“ã«ã€Œ${customerName}ã€æ§˜ã®æ¡ˆä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
        return;
      }
      
      const { error } = await supabase
        .from('inquiries')
        .delete()
        .eq('id', id);
      
      if (error) {
        console.error('ã‚¨ãƒ©ãƒ¼:', error);
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      } else {
        alert('å‰Šé™¤ã—ã¾ã—ãŸ');
        loadCases();
      }
    };
    
    function getPriorityClass(priority) {
      if (priority === 'é«˜') return 'priority-high';
      if (priority === 'è‡³æ€¥') return 'priority-urgent';
      return '';
    }
    
    function getPriorityBadgeClass(priority) {
      if (priority === 'é«˜') return 'priority-high';
      if (priority === 'è‡³æ€¥') return 'priority-urgent';
      return 'priority-normal';
    }
    
    statusFilter.addEventListener('change', loadCases);
    priorityFilter.addEventListener('change', loadCases);
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    editModal.addEventListener('click', (e) => {
      if (e.target === editModal) {
        closeEditModal();
      }
    });
    
    loadCases();
  </script>
</body>
</html>

